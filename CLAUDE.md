# CLAUDE.md

This file provides guidance to Claude Code (claude.ai/code) when working with code in this repository.

## Project Overview

This is a **Svelte 5 component library** that provides a wrapper over the **bwin.js** JavaScript window manager. It enables tiling window management in web applications using modern Svelte 5 patterns. The project is in early POC stage, inspired by Wave Terminal.

**Key Resources:**

- bwin.js documentation: https://bhjsdev.github.io/bwin-docs/
- Built with Svelte 5 and SvelteKit as a reusable library package

## Development Commands

### Essential Commands

```bash
npm run dev              # Start development server with showcase app
npm run storybook        # Launch Storybook for component development
npm pack                 # Build the library package for distribution
npm run build            # Build the production showcase app
```

### Testing

```bash
npm test                 # Run all tests (unit + e2e)
npm run test:unit        # Run Vitest tests only
npm run test:e2e         # Run Playwright e2e tests
```

### Code Quality

```bash
npm run lint             # Run ESLint and Prettier checks
npm run format           # Auto-format code with Prettier
npm run check            # Type check with svelte-check
npm run check:watch      # Type check in watch mode
```

### Library Publishing

```bash
npm run prepack          # Sync SvelteKit + package library (runs automatically before pack)
npm run build            # Build showcase app
npm publish              # Publish to npm (after pack)
```

## Architecture

### Library Structure

The project follows a **dual-purpose structure**:

- **`src/lib/`** - Exportable library code (published to npm)
  - `components/bwin/` - Core window manager components
  - `index.ts` - Main library exports (ALL library components MUST be re-exported here)
  - `types.ts` - TypeScript type definitions

- **`src/routes/`** - Showcase/demo app (NOT published)
  - Demonstrates library usage with live examples
  - Runs on development server via `npm run dev`

- **`dist/`** - Build output from `@sveltejs/package`
  - Generated by `svelte-package` during build
  - Contains types and compiled components

### Core Components

**BwinHost.svelte** - Primary integration component

- Wraps the bwin.js `BinaryWindow` class
- Provides `addPane()` method to dynamically add panes with Svelte components
- Mounts bwin.js into a container element
- Uses Svelte 5's `mount()` API for imperative component instantiation

**SessionComponentFactory.svelte.ts** - Dynamic session loader

- Async factory for loading session components based on type
- Maps session types (chat, terminal, filebrowser, fileeditor) to Svelte components
- Uses `mount()` to create component instances and returns DOM elements for bwin.js

**Session Components** - Pluggable pane content types:

- `ChatSession.svelte`
- `TerminalSession.svelte`
- `FileBrowserSession.svelte`
- `FileEditorSession.svelte`

### Key Integration Pattern

The library bridges **Svelte 5 components** with **vanilla JS bwin.js**:

1. **BwinHost** creates the bwin.js `BinaryWindow` instance
2. Components are mounted imperatively using Svelte 5's `mount()` API
3. The mounted component's target element is passed to bwin.js as pane content
4. bwin.js manages layout/tiling, Svelte handles reactive UI within each pane

Example:

```typescript
const contentElem = document.createElement('div');
mount(Component, {
	target: contentElem,
	props: { sessionId, data }
});
manager.addPane(nodeId, {
	position: 'right',
	content: contentElem
});
```

### bwin.js Integration

The `src/lib/components/bwin/bwin.js` file is the **bundled bwin.js library** (minified vanilla JS). This is imported directly by `BwinHost.svelte` along with `bwin.css` for styling.

**CSS Customization:**
The library exposes CSS custom properties for theming:

- `--bw-*` variables control colors, sizing, spacing
- Example: `--bw-glass-border-color`, `--bw-container-height`
- See `src/routes/+page.svelte` for full variable reference

## Svelte 5 Patterns

This library uses **modern Svelte 5 syntax** exclusively:

### Props

```typescript
let { config = {}, oncreated = () => {}, onupdated = () => {} } = $props();
```

### State

```typescript
let manager = $state<undefined | BinaryWindow>();
let bwinContainer = $state<HTMLElement>();
```

### Effects

```typescript
$effect(() => {
	if (!manager && bwinContainer) {
		manager = new BinaryWindow(config || {});
		manager.mount(bwinContainer);
	}
});
```

**Always:**

- Define TypeScript interfaces for component props
- Use `$props()` for prop destructuring with defaults
- Use `$state()` for reactive state
- Use `$derived()` for computed values
- Use `$effect()` for side effects

## Testing Strategy

The project uses **dual-environment testing** via Vitest:

### 1. Component Tests (Browser Environment)

- Files: `*.svelte.{test,spec}.{js,ts}`
- Runs in real browser via Playwright
- Uses `vitest-browser-svelte` for rendering
- Example pattern:

  ```typescript
  import { render } from 'vitest-browser-svelte';

  test('renders component', async () => {
  	const { container } = render(Component, { props: {} });
  	await expect.element(page.getByRole('button')).toBeVisible();
  });
  ```

### 2. Server Tests (Node Environment)

- Files: `*.{test,spec}.{js,ts}` (excluding `.svelte.`)
- Standard Vitest unit tests for utilities/logic
- No DOM or component rendering

### 3. E2E Tests

- Directory: `e2e/`
- Playwright tests against built preview app
- Full browser automation

## Common Development Workflows

### Adding a New Library Component

1. Create component in `src/lib/components/`
2. **MUST** export from `src/lib/index.ts`
3. Add TypeScript types/interfaces
4. Create Storybook story in `src/stories/`
5. Write component test using `vitest-browser-svelte`
6. Follow Svelte 5 syntax patterns

### Adding a New Session Type

1. Create session component in `src/lib/components/bwin/`
2. Add type mapping in `SessionComponentFactory.svelte.ts`
3. Export from `src/lib/index.ts`
4. Update demo in `src/routes/+page.svelte`

### Working with bwin.js

- **Read bwin.js docs:** https://bhjsdev.github.io/bwin-docs/
- The `BinaryWindow` class manages the tree of sash/pane nodes
- Panes are added relative to existing nodes (top/right/bottom/left)
- Use `manager.addPane(nodeId, options)` to add panes
- Content must be a DOM element (use Svelte's `mount()` to create)

## File Organization

```
src/
├── lib/                          # Published library code
│   ├── components/
│   │   └── bwin/                 # Window manager components
│   │       ├── BwinHost.svelte   # Main wrapper component
│   │       ├── bwin.js           # Bundled bwin.js library
│   │       ├── bwin.css          # bwin.js styles
│   │       ├── SessionComponentFactory.svelte.ts
│   │       └── *Session.svelte   # Session type components
│   ├── index.ts                  # Main exports (REQUIRED)
│   └── types.ts                  # Type definitions
├── routes/                       # Demo app (NOT published)
│   └── +page.svelte              # Live demo/showcase
└── stories/                      # Storybook stories

e2e/                              # Playwright e2e tests
dist/                             # Build output (generated)
```

## TypeScript Configuration

- Strict mode enabled
- `module: "NodeNext"` and `moduleResolution: "NodeNext"`
- `svelte-check` validates types in `.svelte` files
- Path aliases: `$lib` maps to `src/lib/`

## Storybook

- Stories use `@storybook/addon-svelte-csf` format
- Pattern: `Component.svelte` + `Component.stories.svelte`
- Accessibility testing via `@storybook/addon-a11y`
- Launch with `npm run storybook`

## Important Notes

- **Peer dependency:** Svelte 5+ is required (`"svelte": "^5.0.0"`)
- **CSS side effects:** CSS files are marked as side effects in `package.json` to prevent tree-shaking
- **Package exports:** Library exports both types (`dist/index.d.ts`) and components (`dist/index.js`)
- **bwin.js is vendored:** The library includes a bundled copy of bwin.js in `src/lib/components/bwin/`

## Current POC Status

This is an **early proof of concept**:

- Basic window manager integration is functional
- Session component factory demonstrates dynamic loading
- Demo app shows adding multiple session types
- Further work needed for full bwin.js feature coverage

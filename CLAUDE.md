# CLAUDE.md

This file provides guidance to Claude Code (claude.ai/code) when working with code in this repository.

## Project Overview

This is a **native Svelte 5 component library** that provides tiling window management for web applications. Built from the ground up using modern Svelte 5 patterns, it offers a fully reactive, type-safe approach to building tiling window layouts. The project is inspired by Wave Terminal and the concepts from bwin.js, but is a complete native Svelte 5 implementation rather than a wrapper.

**Key Resources:**

- Built with Svelte 5 and SvelteKit as a reusable library package
- bwin.js documentation (conceptual reference): https://bhjsdev.github.io/bwin-docs/

## Development Commands

### Essential Commands

```bash
npm run dev              # Start development server with showcase app
npm run storybook        # Launch Storybook for component development
npm pack                 # Build the library package for distribution
npm run build            # Build the production showcase app
```

### Testing

```bash
npm test                 # Run all tests (unit + e2e)
npm run test:unit        # Run Vitest tests only
npm run test:e2e         # Run Playwright e2e tests
```

### Code Quality

```bash
npm run lint             # Run ESLint and Prettier checks
npm run format           # Auto-format code with Prettier
npm run check            # Type check with svelte-check
npm run check:watch      # Type check in watch mode
```

### Library Publishing

```bash
npm run prepack          # Sync SvelteKit + package library (runs automatically before pack)
npm run build            # Build showcase app
npm publish              # Publish to npm (after pack)
```

## Architecture

### Library Structure

The project follows a **dual-purpose structure**:

- **`src/lib/`** - Exportable library code (published to npm)
  - `components/bwin/` - Core window manager components (native Svelte 5 implementation)
  - `index.ts` - Main library exports (ALL library components MUST be re-exported here)
  - `types.ts` - TypeScript type definitions

- **`src/routes/`** - Showcase/demo app (NOT published)
  - Demonstrates library usage with live examples
  - Runs on development server via `npm run dev`

- **`dist/`** - Build output from `@sveltejs/package`
  - Generated by `svelte-package` during build
  - Contains types and compiled components

### Core Components

**BinaryWindow.svelte** - Primary window manager component

- Manages the binary space partitioning tree of panes
- Provides `addPane()` method to dynamically add panes with Svelte components
- Component-only architecture - all panes MUST use Svelte components (no HTML strings)
- Uses Svelte 5's `mount()` API for imperative component instantiation

**Glass.svelte** - Individual pane component

- Renders the chrome (header, close button) and content for each pane
- Accepts a Svelte component via the `component` prop
- Props are passed to the component via `componentProps`

**Pane Components** - Example pluggable pane content types:

- `ChatSession.svelte`
- `TerminalSession.svelte`
- `FileBrowserSession.svelte`
- `FileEditorSession.svelte`

### Key Integration Pattern

The library uses a **component-only architecture**:

1. **BinaryWindow** manages the pane tree and provides an `addPane()` API
2. All panes MUST be Svelte components (no HTML strings or DOM elements)
3. Components are mounted imperatively using Svelte 5's `mount()` API
4. The library manages layout/tiling while components handle reactive UI

Example:

```typescript
import MyComponent from './MyComponent.svelte';

// Initial pane configuration
const settings = {
	id: 'root',
	title: 'My Pane',
	component: MyComponent,
	componentProps: { message: 'Hello!' }
};

// Add additional panes programmatically
bwin.addPane('root', {
	position: 'right',
	component: MyComponent,
	componentProps: { message: 'Split pane!' }
});
```

### Architecture Philosophy

This library is a **native Svelte 5 implementation** of tiling window management concepts. While inspired by bwin.js, all core functionality is built directly in Svelte 5 using runes, snippets, and reactive state management.

**Key Architectural Decisions:**

1. **Binary Space Partitioning (BSP) Tree**: Panes are organized in a tree structure where each split creates two children
2. **Reactive State**: All pane state is managed using Svelte 5's `$state` rune for automatic reactivity
3. **Component-based**: Every pane renders a Svelte component, ensuring type safety and reactivity
4. **Declarative + Imperative APIs**: Support both declarative configuration and imperative pane manipulation

**CSS Customization:**
The library exposes CSS custom properties for theming:

- `--bw-*` variables control colors, sizing, spacing
- Example: `--bw-glass-border-color`, `--bw-container-height`
- See `src/routes/+page.svelte` for full variable reference

## Svelte 5 Patterns

This library uses **modern Svelte 5 syntax** exclusively:

### Props

```typescript
let { config = {}, oncreated = () => {}, onupdated = () => {} } = $props();
```

### State

```typescript
let manager = $state<undefined | BinaryWindow>();
let bwinContainer = $state<HTMLElement>();
```

### Effects

```typescript
$effect(() => {
	if (!manager && bwinContainer) {
		manager = new BinaryWindow(config || {});
		manager.mount(bwinContainer);
	}
});
```

**Always:**

- Define TypeScript interfaces for component props
- Use `$props()` for prop destructuring with defaults
- Use `$state()` for reactive state
- Use `$derived()` for computed values
- Use `$effect()` for side effects
- Use `Snippet<[ParamType]>` for reusable template fragments

### Snippets

The library uses Svelte 5 snippets for declarative content rendering:

```svelte
<!-- Frame.svelte - Accepts paneContent snippet -->
<Frame {settings}>
  {#snippet paneContent(sash)}
    <Glass
      title={sash.store.title}
      content={sash.store.content}
      {/* ...props from sash.store */}
    />
  {/snippet}
</Frame>
```

**Snippet Pattern**:

- Parent component declares snippet props: `paneContent?: Snippet<[Sash]>`
- Parent passes snippet as children with parameters
- Child component renders snippet: `{@render paneContent(data)}`
- Used for declarative Glass rendering (see DECLARATIVE_GLASS_RENDERING.md)

## Testing Strategy

The project uses **dual-environment testing** via Vitest:

### 1. Component Tests (Browser Environment)

- Files: `*.svelte.{test,spec}.{js,ts}`
- Runs in real browser via Playwright
- Uses `vitest-browser-svelte` for rendering
- Example pattern:

  ```typescript
  import { render } from 'vitest-browser-svelte';

  test('renders component', async () => {
  	const { container } = render(Component, { props: {} });
  	await expect.element(page.getByRole('button')).toBeVisible();
  });
  ```

### 2. Server Tests (Node Environment)

- Files: `*.{test,spec}.{js,ts}` (excluding `.svelte.`)
- Standard Vitest unit tests for utilities/logic
- No DOM or component rendering

### 3. E2E Tests

- Directory: `e2e/`
- Playwright tests against built preview app
- Full browser automation

## Common Development Workflows

### Adding a New Library Component

1. Create component in `src/lib/components/`
2. **MUST** export from `src/lib/index.ts`
3. Add TypeScript types/interfaces
4. Create Storybook story in `src/stories/`
5. Write component test using `vitest-browser-svelte`
6. Follow Svelte 5 syntax patterns

### Adding a New Session Type

1. Create session component in `src/lib/components/bwin/`
2. Add type mapping in `SessionComponentFactory.svelte.ts`
3. Export from `src/lib/index.ts`
4. Update demo in `src/routes/+page.svelte`

### Working with BinaryWindow

- The `BinaryWindow` component manages the tree of sash/pane nodes
- Panes are added relative to existing nodes (top/right/bottom/left)
- Use `bwin.addPane(targetSashId, options)` to add panes
- **Component-only**: Content MUST be a Svelte component (no HTML strings)
- Pass component props via the `componentProps` object

Example:

```typescript
import MyComponent from './MyComponent.svelte';

bwin.addPane('pane-1', {
	position: 'right',
	title: 'New Pane',
	component: MyComponent,
	componentProps: { message: 'Hello!', count: 42 }
});
```

## File Organization

```
src/
├── lib/                          # Published library code
│   ├── components/
│   │   └── bwin/                 # Window manager components (native Svelte 5)
│   │       ├── BinaryWindow.svelte   # Main window manager component
│   │       ├── Glass.svelte          # Individual pane wrapper
│   │       ├── Frame.svelte          # BSP tree renderer
│   │       ├── Sill.svelte           # Horizontal/vertical containers
│   │       ├── GlassState.svelte.ts  # Reactive pane state
│   │       ├── SillState.svelte.ts   # Reactive container state
│   │       └── *Session.svelte       # Session type components
│   ├── index.ts                  # Main exports (REQUIRED)
│   └── types.ts                  # Type definitions
├── routes/                       # Demo app (NOT published)
│   └── +page.svelte              # Live demo/showcase
└── stories/                      # Storybook stories

e2e/                              # Playwright e2e tests
dist/                             # Build output (generated)
```

## TypeScript Configuration

- Strict mode enabled
- `module: "NodeNext"` and `moduleResolution: "NodeNext"`
- `svelte-check` validates types in `.svelte` files
- Path aliases: `$lib` maps to `src/lib/`

## Storybook

- Stories use `@storybook/addon-svelte-csf` format
- Pattern: `Component.svelte` + `Component.stories.svelte`
- Accessibility testing via `@storybook/addon-a11y`
- Launch with `npm run storybook`

## Important Notes

- **Peer dependency:** Svelte 5+ is required (`"svelte": "^5.0.0"`)
- **CSS side effects:** CSS files are marked as side effects in `package.json` to prevent tree-shaking
- **Package exports:** Library exports both types (`dist/index.d.ts`) and components (`dist/index.js`)
- **Native implementation:** All window management logic is implemented natively in Svelte 5
- **Declarative rendering:** Glass components can be rendered declaratively via snippets (see `DECLARATIVE_GLASS_RENDERING.md`)

## Known Warnings

### adapter-auto Warning (Expected)

When running `npm run dev` or `npm run build`, you may see:

```
@sveltejs/adapter-auto: No production environment detected. This warning can be ignored.
```

**This warning is expected and can be safely ignored.** It appears because:

1. The project includes a demo/showcase SvelteKit app in `src/routes/` for development and demonstration purposes
2. This demo app has no production deployment target (no Vercel, Netlify, etc. configuration)
3. The demo app is excluded from the published npm package via `.npmignore`
4. Only the library code from `src/lib/` is packaged and published to npm (via `dist/`)

The warning does not affect:
- The library package build (`npm pack`)
- The published npm package functionality
- Library consumers who install the package

The demo app is purely for local development, Storybook integration, and showcasing library features. It is never deployed or included in the distributed package.

## Current POC Status

This is an **early proof of concept**:

- Native Svelte 5 window manager implementation is functional
- Binary space partitioning (BSP) tree structure for pane organization
- Reactive state management using Svelte 5 runes
- Session component factory demonstrates dynamic loading
- Demo app shows adding multiple session types
- Further refinement needed for production-ready features (drag-and-drop reordering, persistence, etc.)
